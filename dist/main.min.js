"use strict";var request=require("umi-request"),fs=require("fs"),ejs=require("ejs"),path=require("path");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var request__default=_interopDefaultLegacy(request),fs__default=_interopDefaultLegacy(fs),ejs__default=_interopDefaultLegacy(ejs),path__default=_interopDefaultLegacy(path);const getAllDeps=e=>e.split("<").map((e=>e.replace(/>/g,"").replace(/\[\]/g,""))),toGenericsTypes=e=>e.replace(/Â«/g,"<").replace(/Â»/g,">"),toGenerics=e=>1===e.length?e[0]:`${e.join("<")}${e.slice(1).map((()=>">")).join("")}`,removeGenericsSign=e=>e.replace(/<T>/g,""),removeArraySign=e=>e.replace(/\[\]/g,""),report=(e,t)=>{console.log(blue(path__default.default.relative(process.cwd(),e))+" "+getSize(t))},getSize=e=>(e.length/1024).toFixed(2)+"kb",blue=e=>"[1m[34m"+e+"[39m[22m",getType=(e,t)=>{if(!e)return"any";const{type:r}=e;if(!r&&e.originalRef)return e.originalRef;return["int64","integer","long","float","double","number","int","float","double","int32","int64"].includes(r)?"number":["Date","date","dateTime","date-time","datetime"].includes(r)||["string","email","password","url","byte","binary"].includes(r)?"string":"boolean"===r?"boolean":"object"===r?t?"T":e.originalRef??e.additionalProperties?.type??"any":"array"===r?t?"T[]":`${e.items.originalRef??getType(e.items)}[]`:"any"},getParams=(e,t)=>{if(!e||0===e.length)return[];if("body"===e[0]?.in){const r=e?.[0]?.schema.originalRef,a=t[r]?.properties;return Object.keys(a).map((e=>{const t=a[e];return{in:"body",name:e,type:getType(t,!1),description:t.description,required:!1}}))}return e.map((e=>({in:e.in,name:e.name,type:getType(e,!1),description:e.description,required:e.required})))},getUrlText=e=>e.includes("{")?`\`${e.replace(/{/g,"${pathVars.")}\``:`'${e}'`,getApis=(e,t)=>{const r=(e,r)=>{const a=e[200];if(a.schema?.type)return getType(a.schema);if(a.schema?.originalRef){const e=a.schema?.originalRef?.replace(/Â«/g,"<").replace(/Â»/g,">"),n=getAllDeps(e);if(1===n.length&&r.includes(e))return e+"<any>";const s=t.map((e=>removeGenericsSign(e.name)));for(let e=0;e<n.length;e++)s.includes(n[e])||(n[e]="any");return toGenerics(n)}return"any"},a=[];return Object.keys(e.paths).forEach((n=>{const s=e.paths[n];Object.keys(s).forEach((i=>{const o=s[i],p=getParams(o.parameters,e.definitions);a.push({tag:o.tags?.[0],name:o.operationId,description:o.summary,request:{url:n,urlText:getUrlText(n),method:i.toUpperCase(),params:p,filter:{path:p.filter((e=>"path"===e.in)),query:p.filter((e=>"query"===e.in)),body:p.filter((e=>"body"===e.in)),formdata:p.filter((e=>"formdata"===e.in))}},response:{type:r(o.responses,t.filter((e=>e.isGenerics)).map((e=>removeGenericsSign(e.name))))}})}))})),a},getTypeParams=(e,t)=>Object.keys(e).map((r=>{const a=e[r];return{isGenerics:t,name:r,type:getType(a,t),description:a.description,required:!1}})),getTypes=e=>{const t=e.definitions||{},r=new Set;Object.keys(t).forEach((e=>{const t=e.split("Â«");t.pop(),t.forEach((e=>r.add(e)))}));const a=[];return Object.keys(t).forEach((e=>{let n=e;const s=getAllDeps(toGenericsTypes(e));s.length>1&&(n=s[0]);const i=t[e];var o,p;if(i.properties&&!a.some((e=>removeGenericsSign(e.name)===n))){const e=r.has(n);a.push({isGenerics:e,name:e?`${n}<T>`:n,description:i.description||"",params:(o=i.properties,p=e,Object.keys(o).map((e=>{const t=o[e];return{isGenerics:p,name:e,type:getType(t,p),description:t.description,required:!1}})))})}})),a},renderFile=(e,t)=>new Promise(((r,a)=>{ejs__default.default.renderFile(e,t,{},((e,t)=>{e&&a(e.message),r(t)}))})),generateService=async(e,t)=>{const r=getTypes(e),a=path.resolve(__dirname,"../","src","template","type.ejs"),n=await renderFile(a,{types:r}),s=path.resolve(t,"typings.ts");fs__default.default.writeFileSync(s,n),report(s,n);const i=getApis(e,r),o=new Map;e.tags?.forEach((e=>{o.set(e.name,[])})),i.forEach((e=>o.get(e.tag)?.push(e))),o.forEach((async(e,a)=>{const n=path.resolve(__dirname,"../","src","template","umi-request.ejs"),s=new Set;e.forEach((e=>{e.request.params.forEach((e=>{const t=e.type.replace(/\[\]/g,"");r.some((e=>removeGenericsSign(e.name)===t))&&s.add(t)})),getAllDeps(e.response.type).forEach((e=>{r.some((t=>removeGenericsSign(t.name)===e))&&s.add(e)}))}));const i=await renderFile(n,{deps:s,apis:e}),o=path.resolve(t,`${a}.ts`);fs__default.default.writeFileSync(o,i),report(o,i)}))},generate=async e=>{const{data:t,url:r,outputDir:a}=e;if(!t&&!r)throw new Error("please input either data or url!");if(!a)throw new Error("please input outputDir!");let n={};r&&(n=await request__default.default.get(r)),t&&(n=JSON.parse(t)),generateService(n,a)};module.exports=generate;